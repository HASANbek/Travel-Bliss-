<!-- ==================== BLOG MODAL ==================== -->
<div id="blogModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; overflow-y: auto;">
    <div style="background: white; max-width: 800px; margin: 40px auto; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">

        <!-- Header -->
        <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 25px 30px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2 id="blogModalTitle" style="margin: 0; color: white; font-size: 22px;">Yangi Blog Yaratish</h2>
                <p style="margin: 5px 0 0; color: rgba(255,255,255,0.8); font-size: 14px;">Blog ma'lumotlarini kiriting</p>
            </div>
            <button onclick="closeBlogModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer;">&times;</button>
        </div>

        <!-- Steps -->
        <div style="display: flex; padding: 20px 30px; background: #f8f9fa; border-bottom: 1px solid #e5e7eb;">
            <div class="blog-step-indicator" data-step="1" style="flex: 1; text-align: center;">
                <div style="width: 35px; height: 35px; border-radius: 50%; background: #667eea; color: white; display: inline-flex; align-items: center; justify-content: center; font-weight: bold;">1</div>
                <p style="margin: 8px 0 0; font-size: 12px; color: #667eea; font-weight: 600;">Asosiy</p>
            </div>
            <div class="blog-step-indicator" data-step="2" style="flex: 1; text-align: center;">
                <div style="width: 35px; height: 35px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: inline-flex; align-items: center; justify-content: center; font-weight: bold;">2</div>
                <p style="margin: 8px 0 0; font-size: 12px; color: #9ca3af; font-weight: 600;">Rasm</p>
            </div>
            <div class="blog-step-indicator" data-step="3" style="flex: 1; text-align: center;">
                <div style="width: 35px; height: 35px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: inline-flex; align-items: center; justify-content: center; font-weight: bold;">3</div>
                <p style="margin: 8px 0 0; font-size: 12px; color: #9ca3af; font-weight: 600;">Joylashuv</p>
            </div>
            <div class="blog-step-indicator" data-step="4" style="flex: 1; text-align: center;">
                <div style="width: 35px; height: 35px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: inline-flex; align-items: center; justify-content: center; font-weight: bold;">4</div>
                <p style="margin: 8px 0 0; font-size: 12px; color: #9ca3af; font-weight: 600;">SEO</p>
            </div>
        </div>

        <!-- Content -->
        <div style="padding: 30px; max-height: 400px; overflow-y: auto;">

            <!-- Step 1 -->
            <div id="blogStep1">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Blog Sarlavhasi *</label>
                    <input type="text" id="blogTitle" placeholder="Sarlavha..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;" onkeyup="generateSlug()">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">URL Slug</label>
                    <input type="text" id="blogSlug" placeholder="url-slug" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Kategoriya *</label>
                    <select id="blogCategory" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <option value="">Tanlang...</option>
                        <option value="travel-tips">Travel Tips</option>
                        <option value="destinations">Destinations</option>
                        <option value="culture">Culture</option>
                        <option value="adventure">Adventure</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Qisqa Tavsif *</label>
                    <textarea id="blogExcerpt" rows="2" placeholder="Qisqa tavsif..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;"></textarea>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Kontent *</label>
                    <textarea id="blogContent" rows="4" placeholder="Blog matnini yozing..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;"></textarea>
                </div>
            </div>

            <!-- Step 2 -->
            <div id="blogStep2" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Asosiy Rasm</label>
                    <div style="border: 2px dashed #e5e7eb; padding: 40px; text-align: center; border-radius: 8px; cursor: pointer;" onclick="document.getElementById('blogImageInput').click()">
                        <div style="font-size: 40px;">üì∑</div>
                        <p>Rasm yuklash uchun bosing</p>
                        <input type="file" id="blogImageInput" accept="image/*" style="display: none;" onchange="previewImage(this)">
                    </div>
                    <div id="imagePreview" style="margin-top: 15px; display: none;">
                        <img id="previewImg" src="" style="max-width: 100%; border-radius: 8px;">
                    </div>
                </div>
            </div>

            <!-- Step 3 -->
            <div id="blogStep3" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Davlat</label>
                    <select id="blogCountry" onchange="loadCitiesForBlog()" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <option value="">Tanlang...</option>
                        <option value="uzbekistan">üá∫üáø O'zbekiston</option>
                        <option value="kazakhstan">üá∞üáø Qozog'iston</option>
                        <option value="kyrgyzstan">üá∞üá¨ Qirg'iziston</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Shahar</label>
                    <select id="blogCity" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <option value="">Avval davlat tanlang...</option>
                    </select>
                </div>
            </div>

            <!-- Step 4 -->
            <div id="blogStep4" style="display: none;">
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <h3 style="color: white; margin: 0 0 10px;">ü§ñ AI SEO Generator</h3>
                    <button type="button" onclick="generateAISEO()" style="background: white; color: #667eea; border: none; padding: 12px 30px; border-radius: 25px; font-weight: 600; cursor: pointer;">‚ú® Generate SEO</button>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Meta Description</label>
                    <textarea id="blogMetaDescription" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;"></textarea>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Keywords</label>
                    <input type="text" id="blogKeywords" placeholder="kalit, sozlar" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Status</label>
                    <select id="blogStatus" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <option value="draft">Draft</option>
                        <option value="published">Published</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div style="padding: 20px 30px; background: #f8f9fa; border-top: 1px solid #e5e7eb; border-radius: 0 0 16px 16px; display: flex; justify-content: space-between;">
            <button id="blogPrevBtn" onclick="prevBlogStep()" style="padding: 12px 25px; background: #e5e7eb; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: none;">‚Üê Ortga</button>
            <div style="flex: 1;"></div>
            <button onclick="closeBlogModal()" style="padding: 12px 25px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: 600; cursor: pointer; margin-right: 10px;">‚úï Yopish</button>
            <button id="blogNextBtn" onclick="nextBlogStep()" style="padding: 12px 25px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Keyingi ‚Üí</button>
            <button id="blogSaveBtn" onclick="saveBlog()" style="padding: 12px 25px; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: none;">‚úì Saqlash</button>
        </div>
    </div>
</div>

<script>
let currentBlogStep = 1;
let editingBlogId = null;

function openBlogModal(blogId = null) {
    editingBlogId = blogId;
    currentBlogStep = 1;

    // Reset
    ['blogTitle','blogSlug','blogCategory','blogExcerpt','blogContent','blogMetaDescription','blogKeywords'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    document.getElementById('blogStatus').value = 'draft';
    document.getElementById('blogCountry').value = '';
    document.getElementById('blogCity').innerHTML = '<option value="">Avval davlat tanlang...</option>';
    document.getElementById('imagePreview').style.display = 'none';

    document.getElementById('blogModalTitle').textContent = blogId ? 'Blogni Tahrirlash' : 'Yangi Blog Yaratish';
    document.getElementById('blogModal').style.display = 'block';
    showBlogStep(1);
}

function closeBlogModal() {
    document.getElementById('blogModal').style.display = 'none';
}

function showBlogStep(step) {
    currentBlogStep = step;
    for (let i = 1; i <= 4; i++) {
        const el = document.getElementById('blogStep' + i);
        if (el) el.style.display = i === step ? 'block' : 'none';
    }

    document.querySelectorAll('.blog-step-indicator').forEach((el, i) => {
        const circle = el.querySelector('div');
        const label = el.querySelector('p');
        if (i + 1 <= step) {
            circle.style.background = '#667eea';
            circle.style.color = 'white';
            label.style.color = '#667eea';
        } else {
            circle.style.background = '#e5e7eb';
            circle.style.color = '#9ca3af';
            label.style.color = '#9ca3af';
        }
    });

    document.getElementById('blogPrevBtn').style.display = step === 1 ? 'none' : 'inline-block';
    document.getElementById('blogNextBtn').style.display = step === 4 ? 'none' : 'inline-block';
    document.getElementById('blogSaveBtn').style.display = step === 4 ? 'inline-block' : 'none';
}

function nextBlogStep() { if (currentBlogStep < 4) showBlogStep(currentBlogStep + 1); }
function prevBlogStep() { if (currentBlogStep > 1) showBlogStep(currentBlogStep - 1); }

function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function generateSlug() {
    const title = document.getElementById('blogTitle').value;
    document.getElementById('blogSlug').value = title.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-');
}

function generateAISEO() {
    const title = document.getElementById('blogTitle').value;
    if (!title) { alert('Avval sarlavha kiriting!'); return; }

    const excerpt = document.getElementById('blogExcerpt').value;
    const city = document.getElementById('blogCity').value;

    document.getElementById('blogMetaDescription').value = (excerpt || title).substring(0, 160);
    document.getElementById('blogKeywords').value = title.toLowerCase().split(' ').filter(w => w.length > 3).concat(['travel', 'sayohat']).slice(0, 6).join(', ');
    alert('‚úÖ SEO yaratildi!');
}

const countryCities = {
    uzbekistan: ['Toshkent', 'Samarqand', 'Buxoro', 'Xiva', 'Namangan'],
    kazakhstan: ['Almati', 'Nur-Sultan', 'Shymkent'],
    kyrgyzstan: ['Bishkek', 'Osh']
};

function loadCitiesForBlog() {
    const country = document.getElementById('blogCountry').value;
    const citySelect = document.getElementById('blogCity');
    citySelect.innerHTML = '<option value="">Tanlang...</option>';
    (countryCities[country] || []).forEach(city => {
        citySelect.innerHTML += '<option value="' + city + '">' + city + '</option>';
    });
}

async function saveBlog() {
    const title = document.getElementById('blogTitle').value.trim();
    if (!title) { alert('Sarlavha kiritish shart!'); return; }

    const data = {
        title,
        slug: document.getElementById('blogSlug').value || title.toLowerCase().replace(/\s+/g, '-'),
        category: document.getElementById('blogCategory').value,
        excerpt: document.getElementById('blogExcerpt').value,
        content: document.getElementById('blogContent').value,
        location: document.getElementById('blogCity').value,
        metaDescription: document.getElementById('blogMetaDescription').value,
        keywords: document.getElementById('blogKeywords').value,
        status: document.getElementById('blogStatus').value,
        author: 'Admin'
    };

    try {
        const url = editingBlogId ? 'http://localhost:4000/api/blogs/' + editingBlogId : 'http://localhost:4000/api/blogs';
        const res = await fetch(url, {
            method: editingBlogId ? 'PUT' : 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
            alert('‚úÖ Blog saqlandi!');
            closeBlogModal();
            if (typeof loadBlogs === 'function') loadBlogs();
        } else {
            alert(result.message || 'Xatolik!');
        }
    } catch (e) {
        alert('Server xatosi!');
    }
}
</script>
