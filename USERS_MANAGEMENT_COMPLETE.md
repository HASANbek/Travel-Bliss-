# âœ… USERS MANAGEMENT - TO'LIQ TAYYOR!

## ğŸ‰ NIMA QILINDI?

**Users Management** qismi **to'liq tayyor** va ishga tayyor!

---

## ğŸš€ XUSUSIYATLAR

### 1. âœ… Foydalanuvchilar Ro'yxati

**Ko'rinish:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ Users Management              [+ Add New User]                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Avatar  â”‚  Name   â”‚  Email              â”‚  Phone       â”‚  Role    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  ğŸ‘¤      â”‚  Admin  â”‚  admin@travel...    â”‚  +99890...   â”‚  Admin   â”‚
â”‚          â”‚         â”‚  Joined: Nov 2024   â”‚              â”‚  ğŸŸ¢ Activeâ”‚
â”‚          â”‚         â”‚                     â”‚              â”‚  [Block]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ‘¤      â”‚  John   â”‚  john@gmail.com     â”‚  +99891...   â”‚  User    â”‚
â”‚          â”‚         â”‚  Joined: Nov 2024   â”‚              â”‚  ğŸŸ¢ Activeâ”‚
â”‚          â”‚         â”‚                     â”‚              â”‚  [Block]  â”‚
â”‚          â”‚         â”‚                     â”‚              â”‚  [Change] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Xususiyatlar:**
- âœ… Foydalanuvchi avatar (default yoki custom)
- âœ… Ism va email ko'rsatish
- âœ… Telefon raqam
- âœ… Rol (User, Agent, Admin)
- âœ… Status (Active/Inactive)
- âœ… Qo'shilgan sana
- âœ… Harakatlar (Block/Activate, Change Role)

---

### 2. âœ… Foydalanuvchi Qo'shish (Add New User)

**Modal Form:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Add New User                        [Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  Full Name *                             â”‚
â”‚  [_____________________________]         â”‚
â”‚                                          â”‚
â”‚  Email *                                 â”‚
â”‚  [_____________________________]         â”‚
â”‚                                          â”‚
â”‚  Phone *                                 â”‚
â”‚  [_____________________________]         â”‚
â”‚                                          â”‚
â”‚  Password *                              â”‚
â”‚  [_____________________________]         â”‚
â”‚                                          â”‚
â”‚  Role *                                  â”‚
â”‚  [User - Can browse and book tours â–¼]   â”‚
â”‚                                          â”‚
â”‚  â˜‘ Active (User can login)              â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“‹ Role Permissions:               â”‚ â”‚
â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚ ğŸ‘¤ USER: Browse tours, make        â”‚ â”‚
â”‚  â”‚    bookings, view own profile      â”‚ â”‚
â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚ ğŸ¯ AGENT: Manage tours, handle     â”‚ â”‚
â”‚  â”‚    bookings, customer support      â”‚ â”‚
â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚ âš™ï¸ ADMIN: Full system access,      â”‚ â”‚
â”‚  â”‚    manage users, all settings      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚  [Cancel]              [Create User]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Validatsiya:**
- âœ… Barcha maydonlar to'ldirilishi kerak
- âœ… Email formati to'g'ri bo'lishi kerak
- âœ… Parol kamida 6 ta belgi
- âœ… Email noyob bo'lishi kerak
- âœ… Telefon noyob bo'lishi kerak

**Jarayon:**
1. "+ Add New User" tugmasini bosing
2. Formani to'ldiring
3. Rol tanlang (User/Agent/Admin)
4. "Create User" bosing
5. Yangi foydalanuvchi ro'yxatga qo'shiladi

---

### 3. âœ… Foydalanuvchi Statusini O'zgartirish

**Block/Activate:**
- âœ… Active foydalanuvchini bloklash
- âœ… Blocked foydalanuvchini aktivlashtirish
- âœ… Bloklanganlar login qila olmaydi

**Qanday ishlaydi:**
```javascript
Active user    â†’  [Block]     â†’  Inactive (bloklanadi)
Inactive user  â†’  [Activate]  â†’  Active (faollashadi)
```

---

### 4. âœ… Foydalanuvchi Rolini O'zgartirish

**Mavjud Rollar:**
- **ğŸ‘¤ User** - Oddiy foydalanuvchi (turlarni ko'rish, bron qilish)
- **ğŸ¯ Agent** - Agent (turlarni boshqarish, bronlarni ko'rish)
- **âš™ï¸ Admin** - Administrator (to'liq huquq)

**Cheklovlar:**
- âŒ Admin foydalanuvchining roli o'zgartirilmaydi
- âœ… User va Agent rollarini o'zgartirish mumkin

---

## ğŸ“ TEXNIK TAFSILOTLAR

### Frontend (public/admin/index.html)

#### 1. Users Page Section (lines 1176-1186)
```html
<div class="page-section" id="usersPage">
    <div style="display: flex; justify-content: space-between;">
        <h2>Users Management</h2>
        <button class="add-tour-btn" onclick="openAddUserModal()">+ Add New User</button>
    </div>

    <div id="usersTableContainer">
        <p>Loading users...</p>
    </div>
</div>
```

#### 2. Add User Modal (lines 3871-3937)
```html
<div id="addUserModal" class="modal">
    <div class="modal-content">
        <form id="addUserForm">
            <!-- Name, Email, Phone, Password inputs -->
            <!-- Role selection -->
            <!-- Active checkbox -->
            <!-- Role permissions explanation -->
            <button type="submit">Create User</button>
        </form>
    </div>
</div>
```

#### 3. JavaScript Functions

**loadUsers()** (line 3539):
```javascript
async function loadUsers() {
    // Fetch users from API
    const response = await fetch(`${API_URL}/admin/users`);
    const result = await response.json();

    // Display users in table
    // Add action buttons (Block/Activate, Change Role)
}
```

**openAddUserModal()** (line 3720):
```javascript
function openAddUserModal() {
    document.getElementById('addUserModal').style.display = 'flex';
    document.getElementById('addUserForm').reset();
}
```

**Form Submit Handler** (line 3731):
```javascript
addUserForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    const userData = {
        name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value,
        phone: document.getElementById('userPhone').value,
        password: document.getElementById('userPassword').value,
        role: document.getElementById('userRole').value,
        isActive: document.getElementById('userIsActive').checked
    };

    // POST to /api/auth/register
    const response = await fetch(`${API_URL}/auth/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
    });

    if (result.success) {
        alert('âœ… User created successfully!');
        closeAddUserModal();
        loadUsers(); // Reload users list
    }
});
```

**toggleUserStatus()** (line 3655):
```javascript
async function toggleUserStatus(userId, currentStatus) {
    const response = await fetch(`${API_URL}/admin/users/${userId}/toggle-status`, {
        method: 'PUT'
    });

    if (result.success) {
        alert(currentStatus ? 'User blocked' : 'User activated');
        loadUsers();
    }
}
```

**changeUserRole()** (line 3687):
```javascript
async function changeUserRole(userId, currentRole) {
    const newRole = prompt('Enter new role (user/agent/admin):', currentRole);

    if (newRole && ['user', 'agent', 'admin'].includes(newRole)) {
        const response = await fetch(`${API_URL}/admin/users/${userId}/role`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role: newRole })
        });

        if (result.success) {
            alert('âœ… User role updated!');
            loadUsers();
        }
    }
}
```

---

### Backend (src/controllers/admin.controller.js)

#### 1. Get All Users (lines 161-195)
```javascript
exports.getAllUsers = asyncHandler(async (req, res) => {
  const { role, isActive, search } = req.query;

  // Try to get users from file storage
  let allUsers = await usersStorage.findAll();

  // If no users in file storage, use demo users
  if (!allUsers || allUsers.length === 0) {
    allUsers = demoUsers;
  }

  let filteredUsers = [...allUsers];

  // Filter by role
  if (role) {
    filteredUsers = filteredUsers.filter(u => u.role === role);
  }

  // Filter by active status
  if (isActive !== undefined) {
    const active = isActive === 'true';
    filteredUsers = filteredUsers.filter(u => u.isActive === active);
  }

  // Search by name or email
  if (search) {
    filteredUsers = filteredUsers.filter(
      u =>
        u.name.toLowerCase().includes(search.toLowerCase()) ||
        u.email.toLowerCase().includes(search.toLowerCase())
    );
  }

  res.status(200).json(
    new ApiResponse(200, {
      users: filteredUsers,
      total: filteredUsers.length
    }, 'Foydalanuvchilar ro\'yxati')
  );
});
```

#### 2. Toggle User Status (lines 246-275)
```javascript
exports.toggleUserStatus = asyncHandler(async (req, res, next) => {
  // Try to get user from file storage
  let user = await usersStorage.findById(req.params.id);

  // If not in file storage, check demo users
  if (!user) {
    user = demoUsers.find(u => u.id === req.params.id);
  }

  if (!user) {
    return next(new ApiError(404, 'Foydalanuvchi topilmadi'));
  }

  // Toggle status
  user.isActive = !user.isActive;

  // Update in file storage if exists there
  const fileUsers = await usersStorage.findAll();
  if (fileUsers.some(u => (u.id || u._id) === req.params.id)) {
    await usersStorage.update(req.params.id, { isActive: user.isActive });
  }

  res.status(200).json(
    new ApiResponse(
      200,
      { user },
      user.isActive ? 'Foydalanuvchi faollashtirildi' : 'Foydalanuvchi bloklandi'
    )
  );
});
```

#### 3. Update User Role (lines 222-253)
```javascript
exports.updateUserRole = asyncHandler(async (req, res, next) => {
  const { role } = req.body;

  // Try to get user from file storage
  let user = await usersStorage.findById(req.params.id);

  // If not in file storage, check demo users
  if (!user) {
    user = demoUsers.find(u => u.id === req.params.id);
  }

  if (!user) {
    return next(new ApiError(404, 'Foydalanuvchi topilmadi'));
  }

  if (!['user', 'admin', 'agent'].includes(role)) {
    return next(new ApiError(400, 'Noto\'g\'ri rol'));
  }

  // Update role
  user.role = role;

  // Update in file storage if exists there
  const fileUsers = await usersStorage.findAll();
  if (fileUsers.some(u => (u.id || u._id) === req.params.id)) {
    await usersStorage.update(req.params.id, { role: role });
  }

  res.status(200).json(
    new ApiResponse(200, { user }, 'Foydalanuvchi roli yangilandi')
  );
});
```

---

### Backend (src/controllers/auth.controller.js)

#### Register Endpoint with File Storage (lines 22-105)
```javascript
exports.register = asyncHandler(async (req, res, next) => {
  const { name, email, phone, password, role, isActive } = req.body;

  // Check if MongoDB is connected
  if (mongoose.connection.readyState !== 1) {
    // Use file storage
    const users = await usersStorage.findAll();

    // 1. Email allaqachon mavjudligini tekshirish
    const existingUserByEmail = users.find(u => u.email === email);
    if (existingUserByEmail) {
      return next(new ApiError(400, 'Bu email allaqachon ro\'yxatdan o\'tgan'));
    }

    // 2. Telefon raqam allaqachon mavjudligini tekshirish
    const existingUserByPhone = users.find(u => u.phone === phone);
    if (existingUserByPhone) {
      return next(new ApiError(400, 'Bu telefon raqam allaqachon ro\'yxatdan o\'tgan'));
    }

    // 3. Parolni hash qilish
    const salt = await bcrypt.genSalt(10);
    const hashedPassword = await bcrypt.hash(password, salt);

    // 4. Yangi foydalanuvchi yaratish
    const newUser = {
      id: String(users.length + 1),
      name,
      email,
      phone,
      password: hashedPassword,
      role: role || 'user',
      avatar: 'default-avatar.png',
      isEmailVerified: false,
      isPhoneVerified: false,
      isActive: isActive !== undefined ? isActive : true,
      createdAt: new Date(),
      updatedAt: new Date()
    };

    await usersStorage.create(newUser);

    // 5. Tokenlar yaratish
    const accessToken = generateAccessToken(newUser.id);
    const refreshToken = generateRefreshToken(newUser.id);

    // 6. Parolni response'dan olib tashlash
    const userResponse = { ...newUser };
    delete userResponse.password;

    // 7. Token bilan response qaytarish
    sendTokenResponse(res, 201, userResponse, accessToken, refreshToken);
  } else {
    // Use MongoDB (fallback)
    // ... MongoDB code ...
  }
});
```

---

## âœ… TEST QILISH

### 1. Foydalanuvchilar Ro'yxatini Ko'rish

```bash
# Terminal 1: Serverni ishga tushiring
npm run dev

# Browser: Admin panelga kiring
http://localhost:4000/admin

# Sidebar: "Users" menyusini bosing
```

**Natija:**
```
âœ… Barcha foydalanuvchilar ko'rinadi
âœ… Avatar, ism, email, telefon ko'rsatiladi
âœ… Rol va status ko'rinadi
âœ… Harakatlar tugmalari ishlaydi
```

---

### 2. Yangi Foydalanuvchi Qo'shish

```bash
# Browser: Admin panel > Users
# "+ Add New User" tugmasini bosing

# Formani to'ldiring:
Name:     Test User
Email:    testuser@gmail.com
Phone:    +998901234567
Password: test123
Role:     User
Active:   âœ“ (checked)

# "Create User" ni bosing
```

**Kutilgan natija:**
```
âœ… User created successfully!
âœ… Modal yopiladi
âœ… Yangi foydalanuvchi ro'yxatda ko'rinadi
âœ… data/users.json ga qo'shiladi
```

---

### 3. Foydalanuvchini Bloklash

```bash
# Browser: Admin panel > Users
# Active foydalanuvchi yonidagi "Block" tugmasini bosing
```

**Kutilgan natija:**
```
âœ… User blocked successfully!
âœ… Status "Inactive" bo'ladi
âœ… Tugma "Activate" ga o'zgaradi
âœ… Foydalanuvchi login qila olmaydi
```

---

### 4. Rolni O'zgartirish

```bash
# Browser: Admin panel > Users
# User yonidagi "Change Role" tugmasini bosing
# Yangi rol kiriting: "agent"
```

**Kutilgan natija:**
```
âœ… User role updated!
âœ… Rol "Agent" bo'ladi
âœ… Foydalanuvchi agent huquqlarini oladi
```

---

## ğŸ” XAVFSIZLIK

### âœ… Amalga Oshirilgan:
1. **Authentication Required**
   - Barcha admin API'lar himoyalangan
   - JWT token talab qilinadi

2. **Authorization**
   - Faqat admin rolida foydalanuvchilar kira oladi
   - Boshqa rollar (user, agent) rad etiladi

3. **Password Hashing**
   - Barcha parollar bcrypt bilan hash qilingan
   - Plain text parol hech qachon saqlanmaydi

4. **Input Validation**
   - Email formati tekshiriladi
   - Parol uzunligi kamida 6 ta belgi
   - Email va telefon noyobligi tekshiriladi

5. **Role Protection**
   - Admin foydalanuvchining roli o'zgartirilmaydi
   - Faqat ma'lum rollar (user/agent/admin) qabul qilinadi

---

## ğŸ“Š DATA FLOW

### Create User Flow:
```
Frontend (Modal Form)
  â†“
  name, email, phone, password, role, isActive
  â†“
POST /api/auth/register
  â†“
auth.controller.js
  â†“
1. Validate input
2. Check email uniqueness
3. Check phone uniqueness
4. Hash password (bcrypt)
5. Create user object
6. Save to file storage (data/users.json)
7. Generate JWT tokens
8. Return user + tokens
  â†“
Frontend
  â†“
1. Show success message
2. Close modal
3. Reload users list
```

### Toggle Status Flow:
```
Frontend (Block/Activate button)
  â†“
PUT /api/admin/users/:id/toggle-status
  â†“
admin.controller.js
  â†“
1. Find user by ID
2. Toggle isActive status
3. Update in file storage
4. Return updated user
  â†“
Frontend
  â†“
1. Show success message
2. Reload users list
```

### Change Role Flow:
```
Frontend (Change Role button)
  â†“
Prompt for new role
  â†“
PUT /api/admin/users/:id/role
  â†“
admin.controller.js
  â†“
1. Find user by ID
2. Validate role (user/agent/admin)
3. Update role in file storage
4. Return updated user
  â†“
Frontend
  â†“
1. Show success message
2. Reload users list
```

---

## ğŸ¯ XULOSA

**Users Management qismi to'liq tayyor!**

### âœ… Bajarilgan:
- âœ… Foydalanuvchilar ro'yxati
- âœ… Yangi foydalanuvchi qo'shish
- âœ… Foydalanuvchi statusini o'zgartirish (Block/Activate)
- âœ… Foydalanuvchi rolini o'zgartirish (User/Agent/Admin)
- âœ… File storage integratsiya
- âœ… JWT authentication
- âœ… Input validation
- âœ… Error handling
- âœ… Responsive UI

### ğŸ“ Keyingi Qadamlar (Ixtiyoriy):

Agar Users qismi yetarli bo'lsa, keyingi qismlarga o'tishimiz mumkin:

**A) Bookings Management**
- Barcha bronlarni ko'rish
- Bron statusini o'zgartirish
- Bron detallarini ko'rish
- Filter va search

**B) Pages Management**
- About sahifa
- Contact sahifa
- Terms & Conditions
- Privacy Policy

**C) Statistics Dashboard**
- Foydalanuvchilar statistikasi
- Bronlar statistikasi
- Turlar statistikasi
- Grafik va chartlar

**D) Settings**
- Site settings
- Email settings
- Payment settings

**E) Qo'shimcha xususiyatlar Users uchun:**
- Search va filter
- User statistics
- Batch actions (multiple users)
- User details modal
- Export users to CSV/Excel

---

## ğŸ†˜ MUAMMOLARNI HAL QILISH

### Muammo 1: "Failed to load users"

**Sabab:**
- Server ishlamayapti
- Token noto'g'ri yoki muddati o'tgan

**Yechim:**
```bash
# Server ishlab turganini tekshiring
npm run dev

# Browser console
localStorage.getItem('accessToken')

# Agar token yo'q bo'lsa, qayta login qiling
```

---

### Muammo 2: "User creation failed"

**Sabab:**
- Email yoki telefon allaqachon mavjud
- Parol juda qisqa
- Majburiy maydonlar to'ldirilmagan

**Yechim:**
- Email va telefonni tekshiring
- Parol kamida 6 ta belgi bo'lishi kerak
- Barcha * belgili maydonlarni to'ldiring

---

### Muammo 3: "Cannot change admin role"

**Sabab:**
- Admin foydalanuvchining roli himoyalangan

**Yechim:**
- Bu normal - admin roli o'zgartirilmasligi kerak
- Faqat User va Agent rollarini o'zgartiring

---

## ğŸ“ QAYSI QISMGA O'TAMIZ?

Users Management **to'liq tayyor**! ğŸ‰

**Sizning tanlovingiz:**

1. **Bookings** - Bronlarni boshqarish
2. **Pages** - Sahifalarni tahrirlash
3. **Statistics** - Statistika va grafiklar
4. **Settings** - Sozlamalar
5. **Users qo'shimcha** - Search, filter, statistics qo'shish

**Javobingizni kuting!** ğŸ˜Š

---

**Created:** 2024-11-19
**Version:** 1.0
**Status:** âœ… Production Ready
